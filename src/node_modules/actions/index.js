import {
    FETCH_PHONES_FAILURE, FETCH_PHONES_START, FETCH_PHONES_SUCCESS, 
    LOAD_MORE_FAILURE, LOAD_MORE_START, LOAD_MORE_SUCCESS, 
    FETCH_BY_ID_FAILURE, FETCH_BY_ID_START, FETCH_BY_ID_SUCCESS, 
    ADD_TO_BASKET,
    SEARCH_ITEM,
    FETCH_CATEGORIES_FAILURE, FETCH_CATEGORIES_START, FETCH_CATEGORIES_SUCCESS,
    REMOVE_FROM_BASKET,
    CLEAN_BASKET
} from 'actionTypes'
import {fetchPhones as fetchPhonesApi, 
        loadMore as loadMoreApi, 
        fetchPhoneById as fetchPhoneByIdApi,
        fetchCategories as fetchCategoriesApi
    } from 'api'
import {getRenderedPhonesLength} from 'selectors'

export const fetchPhones = () => async dispatch => {
    dispatch({
        type: FETCH_PHONES_START
    })
    
   try {
    const phones = await fetchPhonesApi()
    dispatch ({
        type: FETCH_PHONES_SUCCESS,
        payload: phones
    })
   } catch (err) {
    dispatch ({
        type: FETCH_PHONES_FAILURE,
        payload: err,
        error: true
        })
   }
}

export const loadMore = () => async (dispatch, getState) => {
    const offset = getRenderedPhonesLength(getState())
    dispatch({
        type: LOAD_MORE_START
    })
    
   try {
    const phones = await loadMoreApi({offset})
    dispatch ({
        type: LOAD_MORE_SUCCESS,
        payload: phones
    })
   } catch (err) {
    dispatch ({
        type: LOAD_MORE_FAILURE,
        payload: err,
        error: true
        })
   }
}

export const fetchPhoneById = id => async dispatch => {
    dispatch ({type: FETCH_BY_ID_START})

    try {
        const phone = await fetchPhoneByIdApi(id)
        dispatch ({
            type: FETCH_BY_ID_SUCCESS,
            payload: phone
        })
    } catch (err) {
        dispatch ({
            type: FETCH_BY_ID_FAILURE,
            payload: err,
            error: true
        })
        
    }
}

export const addToBasket = id => dispatch => {
    dispatch ({
        type: ADD_TO_BASKET,
        payload: id
    })
}

export const searchItem = text => dispatch => {
    dispatch ({
        type: SEARCH_ITEM,
        payload: text
    })
}

export const fetchCategories = () => async dispatch => {
    dispatch({type: FETCH_CATEGORIES_START})
  
    try {
      const categories = await fetchCategoriesApi()
      dispatch({
        type: FETCH_CATEGORIES_SUCCESS,
        payload: categories
      })
    } catch (err) {
      dispatch({
        type: FETCH_CATEGORIES_FAILURE,
        payload: err,
        error: true
      })
    }
}

export const removeItemFromBasket = id => dispatch => {
  dispatch ({
      type: REMOVE_FROM_BASKET,
      payload: id
  })
}

export const cleanBasket = () => dispatch => {
    dispatch ({
        type: CLEAN_BASKET
    })
}

export const basketCheckout = phones => () => {
    alert(JSON.stringify(phones))
}
